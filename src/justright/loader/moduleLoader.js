import { Logger, StringUtils } from "coreutil_v1"
import { Url } from "../util/url.js";
import { LoaderInterceptor } from "./loaderInterceptor.js"

const LOG = new Logger("ModuleLoader");

export class ModuleLoader {

    /**
     * 
     * @param {String} modulePath 
     * @param {String} trailStart 
     * @param {Array<LoaderInterceptor>} loaderInterceptors
     */
    constructor(modulePath, trailStart, loaderInterceptors = []) {
    
        /**
         * @type {string}
         */
        this.modulePath = modulePath;

        /**
         * @type {String}
         */
        this.trailStart = trailStart;

        /**
         * @type {Array<LoaderInterceptor>}
         */
        this.loaderInterceptors = loaderInterceptors;

    }

    /**
     * Matches if the configured matchUrl starts with the provided url or
     * if the configured matchUrl is null
     * 
     * @param {Url} url 
     * @returns 
     */
    matches(url){
        // No trailStart means default match
        if (!this.trailStart) {
            return true;
        }

        // No url and non null trailStart, means no match
        if (!url) {
            LOG.error("Url is null");
            return false;
        }

        // No anchor match only if trailStart is "/"
        if (!url.anchor) {
            if (StringUtils.equals(this.trailStart, "/")) {
                return true;
            }
            return false;
        }

        // Exact match for root trailStart
        if (StringUtils.equals(this.trailStart, "/")) {
            return StringUtils.equals(url.anchor, this.trailStart);
        }

        return StringUtils.startsWith(url.anchor, this.trailStart);
    }

    /**
     * 
     * @returns {Promise<Main>}
     */
    async load() {
        try {
            const module = await this.importModule();
            await this.interceptorsPass();
            return module;
        } catch(reason) {
            LOG.warn("Filter rejected " + reason);
            return null;
        }
    }

    /**
     * 
     * @returns {Promise}
     */
    interceptorsPass() {
        const interceptors = this.loaderInterceptors;
        if (interceptors && interceptors.length > 0) {
            let interceptorPromiseChain = interceptors[0].process();
            for (let i = 1; i < interceptors.length; i++) {
                interceptorPromiseChain = interceptorPromiseChain.then(interceptors[i]);
            }
            return interceptorPromiseChain;
        }
        return Promise.resolve();
    }

    async importModule() {
        try {
            const module = await import(this.modulePath);
            return new module.default();
        } catch(reason)  {
            throw reason;
        }
    }

}